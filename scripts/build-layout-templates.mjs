#!/usr/bin/env node

import { readdir, readFile, writeFile, mkdir } from 'node:fs/promises'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const repoRoot = path.resolve(__dirname, '..')

const layoutTemplatesDir = path.join(repoRoot, 'packages/runtime-core/src/renderer/layout-templates')
const authTemplatesDir = path.join(repoRoot, 'packages/runtime-core/src/renderer/auth-templates')
const outputDir = path.join(repoRoot, 'packages/runtime-core/src/renderer/generated')
const layoutsOutputFile = path.join(outputDir, 'builtin-layouts.ts')
const authOutputFile = path.join(outputDir, 'auth-templates.ts')

async function buildTemplateMap(dir) {
  const files = (await readdir(dir)).filter(name => name.endsWith('.liquid')).sort()
  const entries = []
  for (const file of files) {
    const key = path.basename(file, '.liquid')
    const filePath = path.join(dir, file)
    const content = await readFile(filePath, 'utf8')
    entries.push(`  ['${key}', ${JSON.stringify(content)}]`)
  }
  return entries
}

async function build() {
  await mkdir(outputDir, { recursive: true })

  const layoutEntries = await buildTemplateMap(layoutTemplatesDir)
  const layoutContents = `// Auto-generated by scripts/build-layout-templates.mjs\nexport const builtinLayoutTemplates = new Map<string, string>([\n${layoutEntries.join(',\n')}\n])\n`
  await writeFile(layoutsOutputFile, layoutContents, 'utf8')
  console.log(`Built ${layoutEntries.length} builtin layout templates.`)

  const authEntries = await buildTemplateMap(authTemplatesDir)
  const authContents = `// Auto-generated by scripts/build-layout-templates.mjs\nexport const authTemplates = new Map<string, string>([\n${authEntries.join(',\n')}\n])\n`
  await writeFile(authOutputFile, authContents, 'utf8')
  console.log(`Built ${authEntries.length} auth templates.`)
}

build().catch(error => {
  console.error(error)
  process.exitCode = 1
})
